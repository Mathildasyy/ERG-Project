---
title: "Model"
author: "Sun Yan, He Shuqing, Han Yi, Zhao Qianfan"
date: "12/12/2020"
output: pdf_document
---

```{r}
train <- read.csv('~/Documents/Github/ERG-Project/data/train_full.csv')[,-1] 
# set.seed(205)
# train.index <- sample(1:nrow(data), 0.7*nrow(data))
# train <- data[train.index, ]
# test.index <- (-train.index)
# test <- data[test.index,]
```


```{r}
library(leaps)
library(ranger)
library(e1071)
library(glmnet)
library(boot)

fitControl <- trainControl(## 10-fold CV
                           method = "repeatedcv",
                           number = 10,
                           ## repeated ten times
                           repeats = 10)

regfit.forward = regsubsets(Y~.,data = train, nvmax = 47, method = "forward")
reg.summary <- summary(regfit.forward)
min = which.min(reg.summary$cp)
coef <- coef(regfit.forward, min)

# 1. Forward selection
model.fwd <- function(x){
  matrix <- model.matrix(Y~., data =x)[,names(coef)]
  pred <- matrix%*%coef
  return(pred)
}

# 2. Principal Component Regression
set.seed(1)
cv_model_pcr <- train(
  Y ~ ., 
  data = train, 
  method = "pcr",
  trControl = fitControl,
  tuneLength = 100
  )

# 3. Boosting Linear Model
set.seed(1)
BstlmFit <- train(Y~., data = train,
               method = 'BstLm',
               trControl = fitControl)

# 4. Lasso Regression
set.seed(1)
L2Fit <- train(Y ~ ., data = train, 
                 method = "glmnet", 
                 trControl = fitControl)

# 5. Random Forest Regression
set.seed(1)
tuned_randomforest_model <- ranger(
    formula         = Y ~ ., 
    data            = train, 
    num.trees       = 1000,
    mtry            = 20,
    min.node.size   = 3,
    sample.fraction = .8,
    importance      = 'impurity'
  )

```
```{r}
# 6. SVR
# for (i in 1:length(train)){
#   if (class(train[,i]) == "character"){
#     train[,i] = as.factor(train[,i])
#   }
# }
# set.seed(1)
# tc <- tune.control(cross = 10)
# obj_1 <- tune(svm, Y~., kernal = "linear", data = train, ranges = list(gamma = 2^(-2:2), cost = 2^(2:4)), tunecontrol = tc)

```


```{r}
RMSLE <- function(data){
  pred_pcr <- predict(cv_model_pcr, data) # 0.1279845 
  pred_fwd <- as.numeric(model.fwd(data))  # 0.1191135 
  pred_bstlm <- predict(BstlmFit,data) # 0.1366453 
  pre_L2Fit <- as.numeric(predict(L2Fit,data)) # 0.1277953
  pred_ranger <- predict(tuned_randomforest_model, data)$predictions # 0.1376053 
  #pred_svr <- as.numeric(predict(obj_1$best.model, data)) # 0.13454717
  
  prediction <- cbind(pred_fwd, pred_bstlm, pre_L2Fit, pred_ranger, pred_pcr)
  coefficient <- c(0.4,0.0025,0.1,0.25,0.22)
  rmse <- function(x){
    pred <-  prediction %*% x
    return(sqrt(mean((pred - data$Y)^2)))
  }
  coef <- optim(coefficient, rmse)$par
  pred <-  prediction %*% coef
  print(sqrt(mean((pred - data$Y)^2)))
  return(coef)
}
```


```{r}
coef.train <- RMSLE(train)
#RMSLE(test)

# set.seed(2050)
# [1] 0.05716693
# [1] 0.1327926

```


```{r}
# 开始赌博！！
source('~/Documents/Github/ERG-Project/preprocessing/preprocess.R')
```

```{r}
Test <- read.csv('~/Documents/Github/ERG-Project/data/test.csv')[,-1]

Test <- preprocess.feaEngineer(Test)

Test <- preprocess.fixNA(Test)  # Fix the NA problems 

# test.2 <- preprocess.nzv(test,show = 10)
# 
# num.feature <- preprocess.getNum(test.2)
# 
# 
# cat.feature <- preprocess.getCat(test.2)
# 
# testNum <- preprocess.corNum2Num(test.2,num.feature)
# 
# testCat <- preprocess.corCat2Cat(test.2,cat.feature)

remainFeature <- names(Test) %in% names(train)[-ncol(train)]

test2 <- Test[,remainFeature]

```

```{r}
Prediction <- function(data, coef){
  pred_pcr <- predict(cv_model_pcr, data) # 0.1279845 
  pred_fwd <- as.numeric(model.fwd(data))  # 0.1191135 
  pred_bstlm <- predict(BstlmFit,data) # 0.1366453 
  pre_L2Fit <- as.numeric(predict(L2Fit,data)) # 0.1277953
  pred_ranger <- predict(tuned_randomforest_model, data)$predictions # 0.1376053 
  #pred_svr <- as.numeric(predict(obj_1$best.model, data)) # 0.13454717
  
  prediction <- cbind(pred_fwd, pred_bstlm, pre_L2Fit, pred_ranger, pred_pcr)
  pred <-  prediction %*% coef
  return(pred)
}

test3 <- cbind(test2, data.frame(Y= rep(0,nrow(test2))))
Result <- data.frame(SalePrice <- expm1(Prediction(test3, coef.train)))
write.csv(Result,'~/Documents/Github/ERG-Project/Result.csv')
```

